---
title: 插件开发指南
date: '2026-01-04T12:07:02.104Z'
---

本指南将带你完成开发一个 LabFlow 插件的全过程。

## 1. 环境准备

由于 LabFlow 插件需要以 UMD 或 IIFE 格式运行，并且需要排除 `react` 等外部依赖，我们需要配置一个构建工具。推荐使用 `tsup` (基于 esbuild) 或 `vite`。

### 初始化项目

```bash
mkdir my-labflow-plugin
cd my-labflow-plugin
npm init -y
npm install react lucide-react typescript tsup --save-dev
```

### 配置构建工具 (tsup.config.ts)

创建 `tsup.config.ts`，关键是配置 `external` 和 `globalName`（虽然我们主要通过副作用注册，但保持模块清晰很有好）。更重要的是，我们需要确保代码中使用的 `React` 和 `Lucide` 指向全局变量。

**注意**: 最简单的方法是不打包 React，而是假设它存在于全局作用域。

```typescript
import { defineConfig } from 'tsup';

export default defineConfig({
  entry: ['src/index.tsx'],
  format: ['iife'], // 立即执行函数，适合直接在浏览器运行
  globalName: 'MyPlugin',
  minify: true,
  sourcemap: false,
  clean: true,
  // 关键：排除 React 和 Lucide，不打包进插件
  external: ['react', 'lucide-react'],
  // 定义全局变量映射 (esbuild 选项)
  esbuildOptions(options) {
    options.define = {
      'process.env.NODE_ENV': '"production"',
    };
    // 这一步很重要：将 import React from 'react' 转换为 window.React
    options.alias = {
        'react': 'react', // 这里通常需要配合 shim 或者直接在代码里用 window.React
    }
  },
});
```

*更简单的做法*: 在代码中直接使用 `window.React` 或者配置 esbuild 的 `banner` 来注入 shim。

推荐的 `shim.js`:
```javascript
// shim.js
import * as React from 'react';
export { React };
```
但在 LabFlow 插件系统中，最稳妥的方式是**不要在源码里 import React**，或者配置构建工具将 `import React` 映射到 `window.React`。

## 2. 编写插件代码

创建 `src/index.tsx`。

```tsx
// 声明全局类型，以便 TypeScript 识别
declare global {
  interface Window {
    React: any;
    Lucide: any;
    LabFlow: {
      pluginRegistry: {
        register: (plugin: any) => void;
      };
    };
  }
}

// 获取全局依赖
const React = window.React;
const { FileText } = window.Lucide;

// 定义插件组件
const MyPluginComponent = ({ onInsertBlocks, onClose }) => {
  const handleInsert = () => {
    // 创建一个简单的段落块
    const newBlock = {
      id: crypto.randomUUID(),
      type: 'paragraph',
      content: 'Hello from My Plugin!',
    };
    onInsertBlocks([newBlock]);
    // onClose(); // 如果需要插入后关闭
  };

  return (
    <div className="p-4">
      <h2 className="text-lg font-bold mb-4">My Custom Plugin</h2>
      <p className="mb-4 text-sm text-gray-600">
        Click the button below to insert a text block.
      </p>
      <button
        onClick={handleInsert}
        className="w-full py-2 px-4 bg-blue-600 text-white rounded hover:bg-blue-700 transition"
      >
        Insert Hello World
      </button>
    </div>
  );
};

// 注册插件
window.LabFlow.pluginRegistry.register({
  id: 'my-custom-plugin',
  name: 'My Plugin',
  icon: FileText, // 使用 Lucide 图标
  component: MyPluginComponent,
  description: 'A simple example plugin',
});
```

## 3. 构建插件

```bash
npx tsup
```

这将生成 `dist/index.js`。

## 4. 加载插件

### 方法 A: 本地开发测试

1. 打开 LabFlow 编辑器。
2. 打开浏览器控制台 (F12)。
3. 将 `dist/index.js` 的内容复制并粘贴到控制台执行。
4. 你应该能看到侧边栏多了一个 "My Plugin" 的图标。

### 方法 B: 远程加载

如果你的插件托管在 CDN 上 (例如 `https://example.com/my-plugin.js`)，可以在控制台运行：

```javascript
await window.LabFlow.pluginRegistry.loadRemote('https://example.com/my-plugin.js');
```

或者在应用初始化逻辑中添加加载代码。

## 5. 高级技巧：使用 TypeScript 类型

为了获得更好的开发体验，你可以将 LabFlow 的类型定义复制到你的项目中，或者引用 `LabFlow_frontend` 中的类型文件（如果你是在同一个 monorepo 下开发）。

参考 `api-reference.md` 获取详细的接口定义。
